# Comparing `tmp/gitlab_emulator-1.5.3-py3-none-any.whl.zip` & `tmp/gitlab_emulator-1.5.5-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,60 +1,60 @@
-Zip file size: 74997 bytes, number of entries: 58
--rwxr-xr-x  2.0 unx      125 b- defN 23-Mar-29 10:01 gitlab_emulator-1.5.3.data/scripts/locallab.py
--rw-r--r--  2.0 unx        0 b- defN 23-Feb-01 23:22 gitlabemu/__init__.py
--rw-r--r--  2.0 unx       76 b- defN 23-Feb-01 23:22 gitlabemu/__main__.py
--rw-r--r--  2.0 unx      285 b- defN 23-Feb-01 23:22 gitlabemu/ansi.py
--rw-r--r--  2.0 unx     1043 b- defN 23-Mar-29 09:04 gitlabemu/artifacts.py
--rw-r--r--  2.0 unx      786 b- defN 23-Mar-29 09:04 gitlabemu/chown.py
--rw-r--r--  2.0 unx    28146 b- defN 23-Mar-29 10:01 gitlabemu/configloader.py
--rw-r--r--  2.0 unx     1863 b- defN 23-Mar-29 09:04 gitlabemu/configtool.py
--rw-r--r--  2.0 unx     1428 b- defN 23-Mar-29 09:04 gitlabemu/configtool_ctx.py
--rw-r--r--  2.0 unx     1614 b- defN 23-Mar-29 09:04 gitlabemu/configtool_gitlab.py
--rw-r--r--  2.0 unx     6073 b- defN 23-Mar-29 10:01 gitlabemu/configtool_runner.py
--rw-r--r--  2.0 unx     2024 b- defN 23-Mar-29 09:04 gitlabemu/configtool_vars.py
--rw-r--r--  2.0 unx      942 b- defN 23-Mar-29 09:05 gitlabemu/configtool_volumes.py
--rw-r--r--  2.0 unx    26277 b- defN 23-Mar-29 10:01 gitlabemu/docker.py
--rw-r--r--  2.0 unx      855 b- defN 23-Mar-29 09:04 gitlabemu/errors.py
--rw-r--r--  2.0 unx     5029 b- defN 23-Mar-29 09:04 gitlabemu/generator.py
--rw-r--r--  2.0 unx    19321 b- defN 23-Mar-29 09:04 gitlabemu/gitlab_client_api.py
--rw-r--r--  2.0 unx    14815 b- defN 23-Mar-29 09:05 gitlabemu/helpers.py
--rw-r--r--  2.0 unx    20286 b- defN 23-Mar-29 09:05 gitlabemu/jobs.py
--rw-r--r--  2.0 unx     1058 b- defN 23-Mar-29 10:01 gitlabemu/localfiles.py
--rw-r--r--  2.0 unx      709 b- defN 23-Mar-29 09:04 gitlabemu/logmsg.py
--rw-r--r--  2.0 unx     9033 b- defN 23-Mar-29 09:04 gitlabemu/pipelines.py
--rw-r--r--  2.0 unx     1711 b- defN 23-Mar-29 09:04 gitlabemu/pstab.py
--rw-r--r--  2.0 unx     2302 b- defN 23-Mar-29 09:04 gitlabemu/references.py
--rw-r--r--  2.0 unx      901 b- defN 23-Mar-29 09:04 gitlabemu/resnamer.py
--rw-r--r--  2.0 unx     3264 b- defN 23-Mar-29 09:04 gitlabemu/ruleparser.py
--rw-r--r--  2.0 unx    21029 b- defN 23-Mar-29 09:05 gitlabemu/runner.py
--rw-r--r--  2.0 unx     1149 b- defN 23-Mar-29 09:04 gitlabemu/userconfig.py
--rw-r--r--  2.0 unx    13671 b- defN 23-Mar-29 10:01 gitlabemu/userconfigdata.py
--rw-r--r--  2.0 unx      906 b- defN 23-Mar-29 09:04 gitlabemu/variables.py
--rw-r--r--  2.0 unx     2447 b- defN 23-Mar-29 09:04 gitlabemu/yamlloader.py
--rw-r--r--  2.0 unx        0 b- defN 23-Mar-29 09:04 gitlabemu/genericci/__init__.py
--rw-r--r--  2.0 unx     4938 b- defN 23-Mar-29 09:04 gitlabemu/genericci/types.py
--rw-r--r--  2.0 unx        0 b- defN 23-Feb-01 23:22 gitlabemu/gitlab/__init__.py
--rw-r--r--  2.0 unx      340 b- defN 23-Mar-29 09:04 gitlabemu/gitlab/constraints.py
--rw-r--r--  2.0 unx      720 b- defN 23-Mar-29 09:04 gitlabemu/gitlab/types.py
--rw-r--r--  2.0 unx      109 b- defN 23-Mar-29 09:04 gitlabemu/gitlab/urls.py
--rw-r--r--  2.0 unx        0 b- defN 23-Mar-29 09:04 gitlabemu/glp/__init__.py
--rw-r--r--  2.0 unx       28 b- defN 23-Mar-29 09:04 gitlabemu/glp/__main__.py
--rw-r--r--  2.0 unx      880 b- defN 23-Mar-29 09:04 gitlabemu/glp/buildtool.py
--rw-r--r--  2.0 unx      573 b- defN 23-Mar-29 09:04 gitlabemu/glp/canceltool.py
--rw-r--r--  2.0 unx     1160 b- defN 23-Mar-29 09:04 gitlabemu/glp/dumptool.py
--rw-r--r--  2.0 unx     1479 b- defN 23-Mar-29 09:04 gitlabemu/glp/exporttool.py
--rw-r--r--  2.0 unx     1146 b- defN 23-Mar-29 09:04 gitlabemu/glp/jobstool.py
--rw-r--r--  2.0 unx      555 b- defN 23-Mar-29 09:04 gitlabemu/glp/listtool.py
--rw-r--r--  2.0 unx     2276 b- defN 23-Mar-29 09:04 gitlabemu/glp/subcommand.py
--rw-r--r--  2.0 unx     5074 b- defN 23-Mar-29 09:04 gitlabemu/glp/subsettool.py
--rw-r--r--  2.0 unx     1906 b- defN 23-Mar-29 09:04 gitlabemu/glp/tool.py
--rw-r--r--  2.0 unx      780 b- defN 23-Mar-29 09:04 gitlabemu/glp/types.py
--rw-r--r--  2.0 unx     3350 b- defN 23-Mar-29 09:04 gitlabemu/rules/GitlabRuleLexer.py
--rw-r--r--  2.0 unx    15223 b- defN 23-Mar-29 09:04 gitlabemu/rules/GitlabRuleParser.py
--rw-r--r--  2.0 unx     1550 b- defN 23-Mar-29 09:04 gitlabemu/rules/GitlabRuleVisitor.py
--rw-r--r--  2.0 unx        0 b- defN 23-Mar-29 09:04 gitlabemu/rules/__init__.py
--rw-r--r--  2.0 unx      859 b- defN 23-Mar-29 10:01 gitlab_emulator-1.5.3.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Mar-29 10:01 gitlab_emulator-1.5.3.dist-info/WHEEL
--rw-r--r--  2.0 unx      113 b- defN 23-Mar-29 10:01 gitlab_emulator-1.5.3.dist-info/entry_points.txt
--rw-r--r--  2.0 unx       10 b- defN 23-Mar-29 10:01 gitlab_emulator-1.5.3.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     4758 b- defN 23-Mar-29 10:01 gitlab_emulator-1.5.3.dist-info/RECORD
-58 files, 237087 bytes uncompressed, 67491 bytes compressed:  71.5%
+Zip file size: 75710 bytes, number of entries: 58
+-rwxr-xr-x  2.0 unx      125 b- defN 23-May-21 21:46 gitlab_emulator-1.5.5.data/scripts/locallab.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-04 09:47 gitlabemu/__init__.py
+-rw-r--r--  2.0 unx       76 b- defN 23-Mar-04 09:47 gitlabemu/__main__.py
+-rw-r--r--  2.0 unx      285 b- defN 23-Mar-04 09:47 gitlabemu/ansi.py
+-rw-r--r--  2.0 unx     1043 b- defN 23-Mar-04 09:47 gitlabemu/artifacts.py
+-rw-r--r--  2.0 unx      786 b- defN 23-Mar-04 09:47 gitlabemu/chown.py
+-rw-r--r--  2.0 unx    28146 b- defN 23-May-19 06:46 gitlabemu/configloader.py
+-rw-r--r--  2.0 unx     1863 b- defN 23-May-19 06:46 gitlabemu/configtool.py
+-rw-r--r--  2.0 unx     1428 b- defN 23-May-19 06:46 gitlabemu/configtool_ctx.py
+-rw-r--r--  2.0 unx     1614 b- defN 23-May-19 06:46 gitlabemu/configtool_gitlab.py
+-rw-r--r--  2.0 unx     6073 b- defN 23-May-19 06:46 gitlabemu/configtool_runner.py
+-rw-r--r--  2.0 unx     2024 b- defN 23-May-19 06:46 gitlabemu/configtool_vars.py
+-rw-r--r--  2.0 unx      942 b- defN 23-May-19 06:46 gitlabemu/configtool_volumes.py
+-rw-r--r--  2.0 unx    29394 b- defN 23-May-21 21:45 gitlabemu/docker.py
+-rw-r--r--  2.0 unx      855 b- defN 23-Mar-04 09:47 gitlabemu/errors.py
+-rw-r--r--  2.0 unx     5029 b- defN 23-Mar-04 09:47 gitlabemu/generator.py
+-rw-r--r--  2.0 unx    19321 b- defN 23-Mar-04 09:47 gitlabemu/gitlab_client_api.py
+-rw-r--r--  2.0 unx    14642 b- defN 23-May-19 06:46 gitlabemu/helpers.py
+-rw-r--r--  2.0 unx    20501 b- defN 23-May-21 21:45 gitlabemu/jobs.py
+-rw-r--r--  2.0 unx     1010 b- defN 23-May-21 21:45 gitlabemu/localfiles.py
+-rw-r--r--  2.0 unx     1150 b- defN 23-May-19 06:46 gitlabemu/logmsg.py
+-rw-r--r--  2.0 unx     9033 b- defN 23-Mar-04 09:47 gitlabemu/pipelines.py
+-rw-r--r--  2.0 unx     1711 b- defN 23-Mar-04 09:47 gitlabemu/pstab.py
+-rw-r--r--  2.0 unx     2302 b- defN 23-Mar-04 09:47 gitlabemu/references.py
+-rw-r--r--  2.0 unx      901 b- defN 23-Mar-04 09:47 gitlabemu/resnamer.py
+-rw-r--r--  2.0 unx     3264 b- defN 23-Mar-04 09:47 gitlabemu/ruleparser.py
+-rw-r--r--  2.0 unx    21029 b- defN 23-May-19 06:46 gitlabemu/runner.py
+-rw-r--r--  2.0 unx     1149 b- defN 23-Mar-04 09:47 gitlabemu/userconfig.py
+-rw-r--r--  2.0 unx    13883 b- defN 23-May-19 06:46 gitlabemu/userconfigdata.py
+-rw-r--r--  2.0 unx      906 b- defN 23-Mar-04 09:47 gitlabemu/variables.py
+-rw-r--r--  2.0 unx     2447 b- defN 23-Mar-04 09:47 gitlabemu/yamlloader.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-04 09:47 gitlabemu/genericci/__init__.py
+-rw-r--r--  2.0 unx     4938 b- defN 23-Mar-04 09:47 gitlabemu/genericci/types.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-04 09:47 gitlabemu/gitlab/__init__.py
+-rw-r--r--  2.0 unx      340 b- defN 23-Mar-04 09:47 gitlabemu/gitlab/constraints.py
+-rw-r--r--  2.0 unx      720 b- defN 23-Mar-04 09:47 gitlabemu/gitlab/types.py
+-rw-r--r--  2.0 unx      109 b- defN 23-Mar-04 09:47 gitlabemu/gitlab/urls.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-04 09:47 gitlabemu/glp/__init__.py
+-rw-r--r--  2.0 unx       28 b- defN 23-Mar-04 09:47 gitlabemu/glp/__main__.py
+-rw-r--r--  2.0 unx      880 b- defN 23-Mar-04 09:47 gitlabemu/glp/buildtool.py
+-rw-r--r--  2.0 unx      573 b- defN 23-Mar-04 09:47 gitlabemu/glp/canceltool.py
+-rw-r--r--  2.0 unx     1160 b- defN 23-Mar-04 09:47 gitlabemu/glp/dumptool.py
+-rw-r--r--  2.0 unx     1479 b- defN 23-Mar-04 09:47 gitlabemu/glp/exporttool.py
+-rw-r--r--  2.0 unx     1146 b- defN 23-Mar-04 09:47 gitlabemu/glp/jobstool.py
+-rw-r--r--  2.0 unx      555 b- defN 23-Mar-04 09:47 gitlabemu/glp/listtool.py
+-rw-r--r--  2.0 unx     2276 b- defN 23-Mar-04 09:47 gitlabemu/glp/subcommand.py
+-rw-r--r--  2.0 unx     5074 b- defN 23-Mar-04 09:47 gitlabemu/glp/subsettool.py
+-rw-r--r--  2.0 unx     1906 b- defN 23-Mar-04 09:47 gitlabemu/glp/tool.py
+-rw-r--r--  2.0 unx      780 b- defN 23-Mar-04 09:47 gitlabemu/glp/types.py
+-rw-r--r--  2.0 unx     3350 b- defN 23-Mar-04 09:47 gitlabemu/rules/GitlabRuleLexer.py
+-rw-r--r--  2.0 unx    15223 b- defN 23-Mar-04 09:47 gitlabemu/rules/GitlabRuleParser.py
+-rw-r--r--  2.0 unx     1550 b- defN 23-Mar-04 09:47 gitlabemu/rules/GitlabRuleVisitor.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-04 09:47 gitlabemu/rules/__init__.py
+-rw-r--r--  2.0 unx      859 b- defN 23-May-21 21:46 gitlab_emulator-1.5.5.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-21 21:46 gitlab_emulator-1.5.5.dist-info/WHEEL
+-rw-r--r--  2.0 unx      113 b- defN 23-May-21 21:46 gitlab_emulator-1.5.5.dist-info/entry_points.txt
+-rw-r--r--  2.0 unx       10 b- defN 23-May-21 21:46 gitlab_emulator-1.5.5.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     4759 b- defN 23-May-21 21:46 gitlab_emulator-1.5.5.dist-info/RECORD
+58 files, 240852 bytes uncompressed, 68204 bytes compressed:  71.7%
```

## zipnote {}

```diff
@@ -1,8 +1,8 @@
-Filename: gitlab_emulator-1.5.3.data/scripts/locallab.py
+Filename: gitlab_emulator-1.5.5.data/scripts/locallab.py
 Comment: 
 
 Filename: gitlabemu/__init__.py
 Comment: 
 
 Filename: gitlabemu/__main__.py
 Comment: 
@@ -153,23 +153,23 @@
 
 Filename: gitlabemu/rules/GitlabRuleVisitor.py
 Comment: 
 
 Filename: gitlabemu/rules/__init__.py
 Comment: 
 
-Filename: gitlab_emulator-1.5.3.dist-info/METADATA
+Filename: gitlab_emulator-1.5.5.dist-info/METADATA
 Comment: 
 
-Filename: gitlab_emulator-1.5.3.dist-info/WHEEL
+Filename: gitlab_emulator-1.5.5.dist-info/WHEEL
 Comment: 
 
-Filename: gitlab_emulator-1.5.3.dist-info/entry_points.txt
+Filename: gitlab_emulator-1.5.5.dist-info/entry_points.txt
 Comment: 
 
-Filename: gitlab_emulator-1.5.3.dist-info/top_level.txt
+Filename: gitlab_emulator-1.5.5.dist-info/top_level.txt
 Comment: 
 
-Filename: gitlab_emulator-1.5.3.dist-info/RECORD
+Filename: gitlab_emulator-1.5.5.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## gitlabemu/docker.py

```diff
@@ -87,15 +87,15 @@
         except Exception as err:
             raise DockerToolError(f"could not run {basic_args}, {err}")
 
     def is_windows_hyperv(self) -> bool:
         if self._is_hyerv is None:
             self._is_hyerv = False
             if is_windows():  # pramga: cover if windows
-                output = self.docker_call("info", "-f", "{{.Isolation}}")
+                output = self.docker_call("info", "-f", "{{.Isolation}}").stdout.strip()
                 if output == "hyperv":  # pragma: no cover
                     self._is_hyerv = True
         return self._is_hyerv
 
     @property
     def pull_policy(self) -> str:
         return self._pull_policy
@@ -241,22 +241,22 @@
             warning(f"problem running {self.image}")
             raise
 
     def kill(self):
         if self.container:
             self.docker_call("kill", "-s", "9", self.container)
 
-    def check_call(self, cwd, cmd, stdout=None, stderr=None, capture=False):
+    def check_call(self, cwd: str, cmd: List[str], stdout=None, stderr=None, capture=False):
         cmdline = [self.tool, "exec", "-w", cwd, self.container] + cmd
         if capture:
             return subprocess.check_output(cmdline, stderr=stderr)
         else:
             return subprocess.check_call(cmdline, stdout=stdout, stderr=stderr)
 
-    def exec(self, cwd, shell, tty=False, user=None, pipe=True):
+    def exec(self, cwd: str, shell: List[str], tty=False, user=None, pipe=True):
         cmdline = [self.tool, "exec", "-w", cwd]
         cmdline.extend(self.get_envs())
         if user is not None:
             cmdline.extend(["-u", str(user)])
         if tty:  # pragma: no cover
             cmdline.append("-t")
             pipe = False
@@ -284,14 +284,27 @@
         self._image = None
         self.services = []
         self.container = None
         self.docker = DockerTool()
         self._force_pull_policy = None
         self._container_lock = threading.Lock()
         self._has_bash = None
+        self._shell_uid = 0
+        self._shell_gid = 0
+
+    @property
+    def shell_is_user(self):
+        return super().shell_is_user
+
+    @shell_is_user.setter
+    def shell_is_user(self, value: bool):
+        self._shell_is_user = value
+        if value:
+            self._shell_uid = os.getuid()
+            self._shell_gid = os.getgid()
 
     @property
     def docker_image(self) -> str:
         if isinstance(self._image, dict):
             image = self._image.get("name", None)
         else:
             image = self._image
@@ -330,14 +343,16 @@
             if len(self.workspace) > 80:
                 # truncate really long paths even on linux
                 return f"/b/{os.path.basename(self.workspace)[:64]}"
 
         return self.workspace
 
     def allocate_runner(self):
+        if self.runner is None:  # pragma: no cover
+            raise GitlabEmulatorError(f"could not find a local docker runner for this job@ {self.name}")
         super().allocate_runner()
         if self.runner and self.runner.docker:
             if self._image is None:
                 self._image = self.runner.docker.image
             self.docker.privileged = self.runner.docker.privileged
             if self.runner.docker.docker_cli is not None:
                 self.docker.tool = self.runner.docker.docker_cli
@@ -395,15 +410,15 @@
     def run_script(self, lines):
         return self._run_script(lines)
 
     def _run_script(self, lines, attempts=2, user=None):
         task = None
         if user is None:
             if self.shell_is_user:  # pragma: cover if posix
-                user = os.getuid()
+                user = self._shell_uid
 
         filename = "generated-gitlab-script" + self.get_script_fileext()
         temp = os.path.join(tempfile.gettempdir(), filename)
         try:
             with open(temp, "w") as fd:
                 print(lines, file=fd)
             # copy it to the container
@@ -531,33 +546,71 @@
             with docker_services(self, environ) as network:
                 if network:
                     self.docker.network = network
                 for envname in environ:
                     self.docker.add_env(envname, environ[envname])
 
                 if self.docker_entrypoint is not None:
-                    self.docker.entrypoint = self.docker_entrypoint
+                    if is_windows():  # pragma: cover if windows
+                        # windows can't have multiple args
+                        args = self.docker_entrypoint
+                        if len(args) > 0:
+                            if len(args) > 1:
+                                warning("windows docker entrypoint override may fail with several args")
+                            self.docker.entrypoint = args[0]
+                    else:
+                        self.docker.entrypoint = self.docker_entrypoint
                 volumes = self.runner.docker.runtime_volumes()
                 if volumes:
                     info("Extra docker volumes registered:")
                     for item in volumes:
                         info("- {}".format(item))
 
                 self.docker.volumes = volumes + [f"{self.workspace}:{self.inside_workspace}:rw"]
 
                 self.docker.run()
-                self.git_safe_dir()
 
                 if not is_windows():  # pragma: cover if not windows
-                    # work out USER
+                    # work out default USER from the image
                     docker_user_cfg = self.docker.get_user()
                     if docker_user_cfg and ":" in docker_user_cfg:
+                        info(f"Container image defines USER: {docker_user_cfg}")
                         docker_user, docker_grp = docker_user_cfg.split(":", 1)
-                        self.stdout.write(f"Setting ownership to {docker_user}:{docker_grp}")
+                        info(f"Setting ownership to {docker_user}:{docker_grp}")
                         self._run_script(f"chown -R {docker_user}.{docker_grp} .", attempts=1, user="0")
+
+                if self.shell_is_user:
+                    if not is_windows():  # pragma: cover if not windows
+                        # try to make a more functional user account inside the container, this may not always
+                        # work due to missing tools, but it's worth a try
+                        _homedir = "/gle-tmp-home"
+                        _passwd = f"gle:x:{self._shell_uid}:{self._shell_gid}:gitlab-emulator:{_homedir}:/bin/sh"
+                        _shadow = f"gle:!:{self._shell_uid}::::::"
+                        try:
+                            info(f"setting up interactive user with uid={self._shell_uid}..")
+                            self.docker.check_call("/",
+                                                   ["sh", "-c", f"echo {_passwd} >> /etc/passwd"], capture=True)
+                            self.docker.check_call("/",
+                                                   ["sh", "-c", f"echo {_shadow} >> /etc/shadow"], capture=True)
+                            self.docker.check_call("/",
+                                                   ["mkdir", _homedir], capture=True)
+                            self.docker.check_call("/",
+                                                   ["chown", str(self._shell_uid), _homedir], capture=True)
+                            self.docker.check_call("/",
+                                                   ["chgrp", str(self._shell_gid), _homedir], capture=True)
+                            # append this user to the sudoers file
+                            info(f"granting sudo inside container..")
+                            self.docker.check_call("/",
+                                                   ["sh", "-c", f"echo 'gle ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"])
+                            info("interactive user setup completed.")
+                        except subprocess.CalledProcessError:
+                            warning("interactive user setup failed, some features may not work fully.")
+
+                self.git_safe_dir()
+
                 try:
                     lines = self.before_script + self.script
                     if self.enter_shell:
                         lines.extend(self.get_interactive_shell_command())
 
                     self.build_process = self.run_script(make_script(lines, powershell=self.is_powershell()))
                 finally:
```

## gitlabemu/helpers.py

```diff
@@ -9,15 +9,15 @@
 import platform
 import subprocess
 from typing import Optional, List, Dict, Union, Tuple
 from urllib.parse import urlparse
 
 from .errors import DockerExecError
 from .resnamer import resource_owner_alive, is_gle_resource
-from .logmsg import info
+from .logmsg import info, debug
 
 
 class ProcessLineProxyThread(Thread):
     def __init__(self, process, stdout, linehandler=None):
         super(ProcessLineProxyThread, self).__init__()
         self.errors = []
         self.process = process
@@ -227,24 +227,15 @@
                         if os.path.isdir(gitdir):
                             return gitdir
     return None
 
 
 def make_path_slug(text: str) -> str:
     """Convert a string into one suitable for a folder basename"""
-    return re.sub(r"[^a-zA-Z0-9\-\.]", "_", text)
-
-
-def debug_enabled():
-    return os.environ.get("GITLAB_EMULATOR_DEBUG", "no") in ["1", "y", "yes"]
-
-
-def debug_print(msg):
-    if debug_enabled():  # pragma: no cover
-        print("GLE DEBUG: {}".format(msg))
+    return re.sub(r"[^a-zA-Z0-9\-.]", "_", text)
 
 
 def clean_leftovers():
     """Clean up any unused leftover docker containers or networks"""
     from .docker import DockerTool, DockerToolFailed
     tool = DockerTool()
     for container in tool.containers:  # pragma: no cover
@@ -440,14 +431,15 @@
     """
     Return True if this system can run docker containers
     :return:
     """
     # noinspection PyBroadException
     try:
         subprocess.check_output(["docker", "info"], stderr=subprocess.STDOUT)
+        debug("docker detected")
         return True
     except Exception as err:  # pragma: no cover
         pass
     return False  # pragma: no cover
 
 
 def warning(text: str) -> None:
```

## gitlabemu/jobs.py

```diff
@@ -9,17 +9,17 @@
 import subprocess
 import tempfile
 import threading
 import time
 from typing import Optional, Dict, List
 
 from .artifacts import GitlabArtifacts
-from .logmsg import info, fatal, debugrule, warning
+from .logmsg import info, fatal, debugrule, warning, debug
 from .errors import GitlabEmulatorError
-from .helpers import communicate as comm, is_windows, is_apple, is_linux, debug_print, parse_timeout, powershell_escape
+from .helpers import communicate as comm, is_windows, is_apple, is_linux, parse_timeout, powershell_escape
 from .ansi import ANSI_GREEN, ANSI_RESET
 from .ruleparser import evaluate_rule
 from .userconfig import get_user_config_context
 from .userconfigdata import GleRunnerConfig
 from .variables import expand_variable
 from .gitlab.constraints import JOB_PERSISTED_VARIABLES, PIPELINE_PERSISTED_VARIABLES
 
@@ -44,15 +44,14 @@
         self.build_process = None
         self.before_script = []
         self.script = []
         self.after_script = []
         self.error_shell = None
         self.enter_shell = False
         self.before_script_enter_shell = False
-        self.shell_is_user = False
         self.tags = []
         self.stage = "test"
         self.variables = {}
         self.extra_variables = {}
         self.allow_add_variables = True
         self.dependencies = []
         self.needed_artifacts = []
@@ -74,14 +73,23 @@
         self.timeout_seconds = 0
         self.timed_out = False
         self.monitor_thread = None
         self.exit_monitor = False
         self.skipped_reason = None
         self.rules = None
         self.configloader = None
+        self._shell_is_user = False
+
+    @property
+    def shell_is_user(self) -> bool:
+        return self._shell_is_user
+
+    @shell_is_user.setter
+    def shell_is_user(self, value: bool):
+        self._shell_is_user = value
 
     def get_emulator_runner(self) -> GleRunnerConfig:
         ctx = get_user_config_context()
         return ctx.find_runner(image=False, tags=self.tags)
 
     def copy_config(self) -> dict:
         return dict(self._config)
@@ -164,14 +172,15 @@
 
     @property
     def parallel(self) -> Optional[int]:
         return self._parallel
 
     def allocate_runner(self):
         """Finish loading low level details before we run the job"""
+        info("allocating runner")
         if self.shell == "cmd":
             warning("the windows cmd shell is obsolete and does not work on real gitlab any more")
         else:
             self.shell = self.runner.shell
 
         for name, value in self.runner.environment.items():
             if name not in self.variables:
@@ -398,15 +407,15 @@
         temp = tempfile.mkdtemp()
         try:
             ext = self.get_script_fileext()
             generated = os.path.join(temp, "generated-gitlab-script" + ext)
             with open(generated, "w") as fd:
                 print(script, file=fd)
             cmdline = self.shell_command(generated)
-            debug_print("cmdline: {}".format(cmdline))
+            debug("cmdline: {}".format(cmdline))
             if self.enter_shell or self.error_shell:  # pragma: no cover
                 # TODO figure out how to cover tty stuff
                 opened = subprocess.Popen(cmdline,
                                           env=envs,
                                           shell=False,
                                           cwd=self.workspace)
             else:
```

## gitlabemu/localfiles.py

```diff
@@ -1,14 +1,13 @@
 """
 Utils for local file housekeeping
 """
 import os
 from .helpers import is_windows, has_docker
 from .docker import DockerTool
-from .userconfig import get_user_config_context
 
 
 def restore_path_ownership(path):
     path = os.path.abspath(path)
     chowner = os.path.abspath(os.path.join(os.path.dirname(__file__), "chown.py"))
     if not is_windows():  # pragma: cover if not windows
         if os.getuid() != 0:
```

## gitlabemu/logmsg.py

```diff
@@ -11,25 +11,45 @@
 logging.basicConfig(format=FORMAT)
 
 LOGGER = logging.getLogger('gitlab-emulator')
 LOGGER.setLevel(logging.INFO)
 
 FATAL_EXIT = True
 
+AFIRMATIVE = ["y", "yes", "1", "enabled", "on"]
+
+def is_afirmative(txt: str) -> bool:
+    return str(txt).lower() in AFIRMATIVE
+
 
 def enable_rule_debug():
     os.environ["GLE_DEBUG_RULES"] = "y"
 
+def enable_debug():
+    os.environ["GLE_DEBUG"] = "y"
+
 
 def info(msg):
     LOGGER.info(msg)
 
+def debug_enabled() -> bool:
+    return is_afirmative(os.environ.get("GLE_DEBUG", "n"))
+
+
+def debugrule_enabled() -> bool:
+    return is_afirmative(os.environ.get("GLE_DEBUG_RULES", "n"))
+
 
 def debugrule(msg):
-    if os.environ.get("GLE_DEBUG_RULES", "n") != "n":
+    if debugrule_enabled() or debug_enabled():
+        LOGGER.info(f"D: {msg}")
+
+
+def debug(msg):
+    if debug_enabled():
         LOGGER.info(f"D: {msg}")
 
 
 def warning(msg):
     LOGGER.warning(f"W! {msg}")
```

## gitlabemu/userconfigdata.py

```diff
@@ -1,15 +1,14 @@
 import abc
 import os.path
 from typing import Optional, Dict, List, cast
 from yaml import safe_dump, safe_load
 
 from .helpers import plausible_docker_volume, DockerVolume, is_windows, has_docker, notice
-from .logmsg import fatal
-
+from .logmsg import fatal, debug
 
 DEFAULT_CONTEXT = "emulator"
 FORBIDDEN_CONTEXT_NAMES = [
     "current_context",
     # reserved
     "version",
 ]
@@ -231,38 +230,40 @@
     def find_runner(self,
                     image: bool = False,
                     tags: Optional[List[str]] = None,
                     ) -> Optional["GleRunnerConfig"]:
         """Find a runner configuration for the given image+tag combo"""
         if tags is None:
             tags = []
-        runner = None
+
         tagset = set(tags)
+        debug(f"find runner for image={image}, tags={tags}")
         for runner in self.runners + self.builtin_runners():
             if image and runner.executor not in [EXECUTOR_DOCKER, EXECUTOR_DOCKER_WINDOWS]:
                 continue
             if not image:
                 if runner.executor in [EXECUTOR_DOCKER, EXECUTOR_DOCKER_WINDOWS]:
                     continue
+            debug(f"considering runner {runner}")
             if len(tagset) == 0:
                 if runner.run_untagged:
+                    debug(f"matching {runner} - allow untagged")
                     return runner
             else:
                 runner_tagset = set(runner.tags)
                 if tagset.issubset(runner_tagset):
+                    debug(f"matching {runner} - tags {tagset}")
                     return runner
 
         # nothing matched, return the defaults but warn
-        if runner is None:
-            if image:
-                runner = self.get_runner("default-docker")
-            else:
-                runner = self.get_runner("default-shell")
-            notice(f"selecting {runner}")
-
+        if image:
+            runner = self.get_runner("default-docker", builtins=True)
+        else:
+            runner = self.get_runner("default-shell", builtins=True)
+        debug(f"matched default {runner}")
         return runner
 
     def get_runner(self, name: str, builtins=False) -> Optional["GleRunnerConfig"]:
         runners = list(self.runners)
         if builtins:
             runners.extend(self.builtin_runners())
         for runner in runners:
```

## Comparing `gitlab_emulator-1.5.3.dist-info/METADATA` & `gitlab_emulator-1.5.5.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: gitlab-emulator
-Version: 1.5.3
+Version: 1.5.5
 Summary: Run/Inspect a .gitlab-ci.yml jobs and pipelines locally
 Home-page: https://gitlab.com/cunity/gitlab-emulator
 Author: Ian Norton
 Author-email: inorton@gmail.com
 License: License :: OSI Approved :: MIT License
 Platform: any
 Requires-Dist: pyyaml (>=5.1)
```

## Comparing `gitlab_emulator-1.5.3.dist-info/RECORD` & `gitlab_emulator-1.5.5.dist-info/RECORD`

 * *Files 7% similar despite different names*

```diff
@@ -1,36 +1,36 @@
-gitlab_emulator-1.5.3.data/scripts/locallab.py,sha256=NMziiHAT5Iwx9cAekIfJ8-6pYXr0OWA6m6UeVO4_PMM,125
+gitlab_emulator-1.5.5.data/scripts/locallab.py,sha256=NMziiHAT5Iwx9cAekIfJ8-6pYXr0OWA6m6UeVO4_PMM,125
 gitlabemu/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 gitlabemu/__main__.py,sha256=dIhMLC-IhR1Oj9OxFyS2KfqTOFx3F9o9Nf9IJMrpZeQ,76
 gitlabemu/ansi.py,sha256=zFmlWuE8a8llZ1sBzq0yON4YlpqCcbN3ZDjQ5K0n0VM,285
 gitlabemu/artifacts.py,sha256=O4mvdP6qGAUpGTrXtaOBRjpgnHU9DTisyMyCe9b1TRk,1043
 gitlabemu/chown.py,sha256=Ynf6_evsokd0P9TqhiIxJ9eGJbXoE2HkFgDYRVqm7QU,786
 gitlabemu/configloader.py,sha256=rqiWFZngJ1I9ymWVa7ILRuiALqZIOGn5c4mSlE4rxT8,28146
 gitlabemu/configtool.py,sha256=_i77n1RyBtW-KJ2cPDlKkD7nhcvwNjuQoPFPjnlybQQ,1863
 gitlabemu/configtool_ctx.py,sha256=rbYPMg4F650H1RqioRAhZtANLnyUVTqf5kE3I6wNNCE,1428
 gitlabemu/configtool_gitlab.py,sha256=ix1zm3eM6wTkMKLJIY-OXusZa9A2_kM1rfbmYuNQjtE,1614
 gitlabemu/configtool_runner.py,sha256=hIhNvux6aDfNcgYcG1kN8g9BOTUPzSv0A5ExPJ59_EE,6073
 gitlabemu/configtool_vars.py,sha256=XqhZkfi20pRGI6o99p3WCFA_kU4iZhc5rqd-e7WNmCI,2024
 gitlabemu/configtool_volumes.py,sha256=hqKA3TlhiRrqHmQVAgt0Efkl8m9MxUYSt47CPLK3_hI,942
-gitlabemu/docker.py,sha256=O8NeUm7K2--I9WsD2t9aNO9cREx75FkJ8sEw-AhMsHA,26277
+gitlabemu/docker.py,sha256=lLxRAAvFAQWmiRMwdelL0znWDsgNcwhenjAv6R1pFcE,29394
 gitlabemu/errors.py,sha256=lgxulpeijXP4r-1v6EFyNV9hvsvcONujgI0IWU63MHU,855
 gitlabemu/generator.py,sha256=haP33slIMEA-RQ9QMuNDDzj2TcUVMuMaD9mfwNUKs5Y,5029
 gitlabemu/gitlab_client_api.py,sha256=-bmx21w9559OZpwVSVJ94KfaeFIqNYEhvjkMzNp4qk0,19321
-gitlabemu/helpers.py,sha256=eZDVfoPSQCqZ4egYqJ-M9G3IVS8-8CIku1zkjy87-6c,14815
-gitlabemu/jobs.py,sha256=1mQIJ61SdAF0Buf9czBPNIkuZN4OJmMFy5V0dvi5CT4,20286
-gitlabemu/localfiles.py,sha256=ROGiCaoPehRRJoA9rs5YyYuocSGgVR7-5pQ2_zipg9Y,1058
-gitlabemu/logmsg.py,sha256=rri260iLPSl5Q2GIuFnOioineOmrjbpyDrexRPwJIUc,709
+gitlabemu/helpers.py,sha256=SX7O9Rt7HNTM2Ab8vaQiNJeQYckCjrbGaFetsbobN7g,14642
+gitlabemu/jobs.py,sha256=Jqurr8F0-FNwy5tbqIquY7-kxfqTh0auK1iBbt3xsOI,20501
+gitlabemu/localfiles.py,sha256=Tx6TrjNoP-Xl1uyhf-3GDwPdTyEyiqRmpaELPAT0K2o,1010
+gitlabemu/logmsg.py,sha256=M6LQ2kv1CAIaS7sOtNtZbj3zWtHa9QqCn0kDpC0mIFI,1150
 gitlabemu/pipelines.py,sha256=UltQT7xWlh6AAbsoPp_7v1GHhpx35IetI75NtzoeriU,9033
 gitlabemu/pstab.py,sha256=Ov9ErIZzQkcZDaBmQ2lMf8Em0YDP0XTjuyKArZu-hJE,1711
 gitlabemu/references.py,sha256=-yWbrVWepmHaZBHrRi8DDDGAyWFkhu864e-LVRpie8E,2302
 gitlabemu/resnamer.py,sha256=JGE33OvzzSFab9vUist78C4MVCM0vVVCrcgpT3x5pl4,901
 gitlabemu/ruleparser.py,sha256=i-9AqRHe3pZhSNwA-Z1YRcFUEPPSEr4nBfzW1WEKuTM,3264
 gitlabemu/runner.py,sha256=htp9Ghz5qw8hfz2JIK9ILBpY528x5Nrz-19hA67B0jk,21029
 gitlabemu/userconfig.py,sha256=rf5QnAabJwM3R1QJZtxEiEEuSbrjobf0WabhpGPcgf0,1149
-gitlabemu/userconfigdata.py,sha256=WUjCaNH_2lP6_66O01wzU5wxmGH-hcFGMAJt6o5UHfM,13671
+gitlabemu/userconfigdata.py,sha256=8R-E_EDNFBCgbqsiiBpP5treniGl3D9VQmHr4aXiRQI,13883
 gitlabemu/variables.py,sha256=VG2Vkhwjdi1wdWu7mPjpVLAEsVzuKoH3_FHjq1JqwOU,906
 gitlabemu/yamlloader.py,sha256=AeMkCJKUS_IuwcYvLZT8J6rWr_ayjfwp5ublV0TDf9A,2447
 gitlabemu/genericci/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 gitlabemu/genericci/types.py,sha256=Q7B-TjEUjO6Ln_Rkwkad07dfm03tjqdjIaRBAR0VY1Q,4938
 gitlabemu/gitlab/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 gitlabemu/gitlab/constraints.py,sha256=Obq7B4HBVLV46t2bznFyN8nbBAW8pQigi7AquuFoO58,340
 gitlabemu/gitlab/types.py,sha256=NzdUif98EmkJ1RXXDorBVTmb2a3TChvaxF6JXtRehYU,720
@@ -47,12 +47,12 @@
 gitlabemu/glp/subsettool.py,sha256=_Ws1TingrCBbNGFdKseTLluYdIZWa5brQVFD6PCuhic,5074
 gitlabemu/glp/tool.py,sha256=jW0AS0Scrf70snB1TgFvSuKreHi1g5qEXXI9qUmRO_Q,1906
 gitlabemu/glp/types.py,sha256=0oyZwZhkWFHOUJtcK4h0hj3S96OqkMXXKtKl5qhgIuU,780
 gitlabemu/rules/GitlabRuleLexer.py,sha256=MCjp46og0bIZgEYBOI0K9x-M_sk5t3AjNK4KepghpCQ,3350
 gitlabemu/rules/GitlabRuleParser.py,sha256=tOtqGxQaeJLkoQfXnG4xpWf009DC_QBGa_C0EYdXTX4,15223
 gitlabemu/rules/GitlabRuleVisitor.py,sha256=FTbdHtgdLWPWBvsSwMNAH8nlYyYsblAZbDoPQAOI2cE,1550
 gitlabemu/rules/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-gitlab_emulator-1.5.3.dist-info/METADATA,sha256=DSEaxVe4iOJWaNdj6wmE4ij16t7Qi1zDlv1wrr734ts,859
-gitlab_emulator-1.5.3.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-gitlab_emulator-1.5.3.dist-info/entry_points.txt,sha256=PK5X6B57JD9w1f8NDmt3REzkZm6aF0XoHvOoCh48ayw,113
-gitlab_emulator-1.5.3.dist-info/top_level.txt,sha256=iHfyzwynY0_rzNMxNSGez2uET21lTIm8BSnAIjzZB3o,10
-gitlab_emulator-1.5.3.dist-info/RECORD,,
+gitlab_emulator-1.5.5.dist-info/METADATA,sha256=jA4SqklVtN3JjnUXkJ_EH9oqn2o2expB0sbo5DYWHno,859
+gitlab_emulator-1.5.5.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+gitlab_emulator-1.5.5.dist-info/entry_points.txt,sha256=PK5X6B57JD9w1f8NDmt3REzkZm6aF0XoHvOoCh48ayw,113
+gitlab_emulator-1.5.5.dist-info/top_level.txt,sha256=iHfyzwynY0_rzNMxNSGez2uET21lTIm8BSnAIjzZB3o,10
+gitlab_emulator-1.5.5.dist-info/RECORD,,
```

