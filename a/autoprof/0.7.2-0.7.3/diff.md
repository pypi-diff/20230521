# Comparing `tmp/autoprof-0.7.2-py2.py3-none-any.whl.zip` & `tmp/autoprof-0.7.3-py2.py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,83 +1,84 @@
-Zip file size: 150388 bytes, number of entries: 81
+Zip file size: 152455 bytes, number of entries: 82
 -rw-rw-r--  2.0 unx     3171 b- defN 23-Mar-17 23:11 autoprof/AP_config.py
--rw-rw-r--  2.0 unx     5755 b- defN 23-May-10 21:56 autoprof/__init__.py
+-rw-rw-r--  2.0 unx     5755 b- defN 23-May-21 17:43 autoprof/__init__.py
 -rw-rw-r--  2.0 unx      281 b- defN 23-Mar-17 23:11 autoprof/__main__.py
 -rw-rw-r--  2.0 unx     1092 b- defN 23-May-02 20:08 autoprof/fit/__init__.py
--rw-rw-r--  2.0 unx     6682 b- defN 23-May-04 13:21 autoprof/fit/base.py
+-rw-rw-r--  2.0 unx     6682 b- defN 23-May-21 17:43 autoprof/fit/base.py
 -rw-rw-r--  2.0 unx       30 b- defN 23-Apr-08 19:05 autoprof/fit/gp.py
--rw-rw-r--  2.0 unx     6704 b- defN 23-Apr-08 19:05 autoprof/fit/gradient.py
--rw-rw-r--  2.0 unx     6912 b- defN 23-May-10 20:09 autoprof/fit/hmc.py
--rw-rw-r--  2.0 unx    13206 b- defN 23-Apr-08 19:05 autoprof/fit/iterative.py
--rw-rw-r--  2.0 unx    31364 b- defN 23-May-08 01:46 autoprof/fit/lm.py
--rw-rw-r--  2.0 unx     4317 b- defN 23-May-02 20:08 autoprof/fit/mhmcmc.py
--rw-rw-r--  2.0 unx     7109 b- defN 23-May-10 20:09 autoprof/fit/nuts.py
--rw-rw-r--  2.0 unx     1125 b- defN 23-Apr-21 02:55 autoprof/image/__init__.py
+-rw-rw-r--  2.0 unx     6704 b- defN 23-May-21 17:43 autoprof/fit/gradient.py
+-rw-rw-r--  2.0 unx     6912 b- defN 23-May-21 17:43 autoprof/fit/hmc.py
+-rw-rw-r--  2.0 unx    13206 b- defN 23-May-21 17:43 autoprof/fit/iterative.py
+-rw-rw-r--  2.0 unx    31364 b- defN 23-May-21 17:43 autoprof/fit/lm.py
+-rw-rw-r--  2.0 unx     4317 b- defN 23-May-21 17:43 autoprof/fit/mhmcmc.py
+-rw-rw-r--  2.0 unx     7109 b- defN 23-May-21 17:43 autoprof/fit/nuts.py
+-rw-rw-r--  2.0 unx     1150 b- defN 23-May-21 17:33 autoprof/image/__init__.py
 -rw-rw-r--  2.0 unx    11195 b- defN 23-Apr-21 02:55 autoprof/image/image_header.py
--rw-rw-r--  2.0 unx    21644 b- defN 23-Apr-21 02:55 autoprof/image/image_object.py
+-rw-rw-r--  2.0 unx    21644 b- defN 23-May-21 02:29 autoprof/image/image_object.py
 -rw-rw-r--  2.0 unx     5269 b- defN 23-Apr-21 02:55 autoprof/image/jacobian_image.py
 -rw-rw-r--  2.0 unx     6615 b- defN 23-Apr-21 02:55 autoprof/image/model_image.py
--rw-rw-r--  2.0 unx    15842 b- defN 23-Apr-21 02:55 autoprof/image/target_image.py
+-rw-rw-r--  2.0 unx     6868 b- defN 23-May-21 17:33 autoprof/image/psf_image.py
+-rw-rw-r--  2.0 unx    14679 b- defN 23-May-21 17:33 autoprof/image/target_image.py
 -rw-rw-r--  2.0 unx    22836 b- defN 23-Apr-21 02:55 autoprof/image/window_object.py
 -rw-rw-r--  2.0 unx      654 b- defN 23-Apr-01 17:55 autoprof/models/__init__.py
--rw-rw-r--  2.0 unx     4277 b- defN 23-Apr-21 02:55 autoprof/models/_model_methods.py
+-rw-rw-r--  2.0 unx     4277 b- defN 23-May-21 17:43 autoprof/models/_model_methods.py
 -rw-rw-r--  2.0 unx    20408 b- defN 23-May-10 21:56 autoprof/models/_shared_methods.py
--rw-rw-r--  2.0 unx    21256 b- defN 23-May-10 21:56 autoprof/models/core_model.py
+-rw-rw-r--  2.0 unx    21301 b- defN 23-May-21 17:43 autoprof/models/core_model.py
 -rw-rw-r--  2.0 unx     5971 b- defN 23-May-10 21:56 autoprof/models/edgeon_model.py
 -rw-rw-r--  2.0 unx    12945 b- defN 23-May-10 21:56 autoprof/models/exponential_model.py
 -rw-rw-r--  2.0 unx     2025 b- defN 23-May-10 21:56 autoprof/models/flatsky_model.py
 -rw-rw-r--  2.0 unx     8373 b- defN 23-May-10 21:56 autoprof/models/foureirellipse_model.py
 -rw-rw-r--  2.0 unx     4905 b- defN 23-May-10 21:56 autoprof/models/galaxy_model_object.py
 -rw-rw-r--  2.0 unx    11956 b- defN 23-May-10 21:56 autoprof/models/gaussian_model.py
--rw-rw-r--  2.0 unx    14833 b- defN 23-May-10 21:56 autoprof/models/group_model_object.py
--rw-rw-r--  2.0 unx    25919 b- defN 23-May-10 21:56 autoprof/models/model_object.py
+-rw-rw-r--  2.0 unx    14833 b- defN 23-May-21 17:43 autoprof/models/group_model_object.py
+-rw-rw-r--  2.0 unx    26717 b- defN 23-May-21 17:43 autoprof/models/model_object.py
 -rw-rw-r--  2.0 unx     3487 b- defN 23-May-10 21:56 autoprof/models/moffat_model.py
 -rw-rw-r--  2.0 unx    17419 b- defN 23-May-10 21:56 autoprof/models/nuker_model.py
--rw-rw-r--  2.0 unx    17694 b- defN 23-May-02 20:08 autoprof/models/parameter_object.py
+-rw-rw-r--  2.0 unx    17694 b- defN 23-May-21 17:43 autoprof/models/parameter_object.py
 -rw-rw-r--  2.0 unx     2292 b- defN 23-May-10 21:56 autoprof/models/planesky_model.py
--rw-rw-r--  2.0 unx     3519 b- defN 23-May-10 21:56 autoprof/models/psf_model.py
+-rw-rw-r--  2.0 unx     3590 b- defN 23-May-21 17:33 autoprof/models/psf_model.py
 -rw-rw-r--  2.0 unx     4653 b- defN 23-May-10 21:56 autoprof/models/ray_model.py
 -rw-rw-r--  2.0 unx    14762 b- defN 23-May-10 21:56 autoprof/models/sersic_model.py
 -rw-rw-r--  2.0 unx      875 b- defN 23-Mar-17 23:11 autoprof/models/sky_model_object.py
 -rw-rw-r--  2.0 unx    10300 b- defN 23-May-10 21:56 autoprof/models/spline_model.py
 -rw-rw-r--  2.0 unx     1125 b- defN 23-Mar-17 23:11 autoprof/models/star_model_object.py
 -rw-rw-r--  2.0 unx     3073 b- defN 23-Mar-17 23:11 autoprof/models/superellipse_model.py
 -rw-rw-r--  2.0 unx     4412 b- defN 23-May-10 21:56 autoprof/models/warp_model.py
 -rw-rw-r--  2.0 unx     3546 b- defN 23-Apr-21 02:55 autoprof/models/wedge_model.py
 -rw-rw-r--  2.0 unx       57 b- defN 23-Feb-16 02:48 autoprof/parse_config/__init__.py
 -rw-rw-r--  2.0 unx     4147 b- defN 23-Mar-17 23:11 autoprof/parse_config/basic_config.py
 -rw-rw-r--  2.0 unx     4590 b- defN 23-Mar-17 23:11 autoprof/parse_config/galfit_config.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Feb-16 02:48 autoprof/parse_config/shared_methods.py
 -rw-rw-r--  2.0 unx       67 b- defN 22-Oct-27 02:37 autoprof/plots/__init__.py
--rw-rw-r--  2.0 unx     6903 b- defN 23-May-04 03:13 autoprof/plots/image.py
+-rw-rw-r--  2.0 unx     6903 b- defN 23-May-21 17:43 autoprof/plots/image.py
 -rw-rw-r--  2.0 unx     7559 b- defN 23-May-01 22:29 autoprof/plots/profile.py
 -rw-rw-r--  2.0 unx     3048 b- defN 23-Mar-17 23:11 autoprof/plots/shared_elements.py
 -rw-rw-r--  2.0 unx    19994 b- defN 23-May-02 20:08 autoprof/plots/visuals.py
 -rw-rw-r--  2.0 unx        0 b- defN 22-Sep-15 14:58 autoprof/utils/__init__.py
 -rw-rw-r--  2.0 unx      800 b- defN 23-Mar-30 13:28 autoprof/utils/angle_operations.py
 -rw-rw-r--  2.0 unx      472 b- defN 23-May-10 21:56 autoprof/utils/decorators.py
 -rw-rw-r--  2.0 unx     9820 b- defN 23-May-10 20:09 autoprof/utils/interpolate.py
 -rw-rw-r--  2.0 unx     6369 b- defN 23-Apr-28 21:02 autoprof/utils/operations.py
 -rw-rw-r--  2.0 unx      963 b- defN 23-Mar-17 23:11 autoprof/utils/optimization.py
 -rw-rw-r--  2.0 unx     5990 b- defN 23-Apr-01 17:55 autoprof/utils/parametric_profiles.py
 -rw-rw-r--  2.0 unx        0 b- defN 22-Dec-16 16:54 autoprof/utils/conversions/__init__.py
 -rw-rw-r--  2.0 unx     2317 b- defN 23-Mar-17 23:11 autoprof/utils/conversions/coordinates.py
 -rw-rw-r--  2.0 unx     1095 b- defN 23-Mar-21 14:13 autoprof/utils/conversions/dict_to_hdf5.py
 -rw-rw-r--  2.0 unx     1829 b- defN 23-Mar-30 13:28 autoprof/utils/conversions/functions.py
--rw-rw-r--  2.0 unx     2728 b- defN 23-Mar-30 13:28 autoprof/utils/conversions/optimization.py
+-rw-rw-r--  2.0 unx     3154 b- defN 23-May-11 14:59 autoprof/utils/conversions/optimization.py
 -rw-rw-r--  2.0 unx     2536 b- defN 23-Mar-30 13:28 autoprof/utils/conversions/units.py
 -rw-rw-r--  2.0 unx      281 b- defN 23-May-04 13:15 autoprof/utils/initialize/__init__.py
 -rw-rw-r--  2.0 unx     3103 b- defN 23-Mar-30 13:28 autoprof/utils/initialize/center.py
 -rw-rw-r--  2.0 unx     4495 b- defN 23-May-04 13:20 autoprof/utils/initialize/construct_psf.py
 -rw-rw-r--  2.0 unx     3921 b- defN 23-Mar-17 23:11 autoprof/utils/initialize/initialize.py
 -rw-rw-r--  2.0 unx     7036 b- defN 23-Mar-30 13:28 autoprof/utils/initialize/segmentation_map.py
 -rw-rw-r--  2.0 unx        0 b- defN 22-Dec-16 16:54 autoprof/utils/isophote/__init__.py
 -rw-rw-r--  2.0 unx     1085 b- defN 23-Mar-17 23:11 autoprof/utils/isophote/ellipse.py
 -rw-rw-r--  2.0 unx     8531 b- defN 23-Mar-30 13:28 autoprof/utils/isophote/extract.py
 -rw-rw-r--  2.0 unx     7012 b- defN 23-Mar-17 23:11 autoprof/utils/isophote/integrate.py
--rw-rw-r--  2.0 unx    35149 b- defN 23-May-10 21:57 autoprof-0.7.2.dist-info/LICENSE
--rw-rw-r--  2.0 unx     3812 b- defN 23-May-10 21:57 autoprof-0.7.2.dist-info/METADATA
--rw-rw-r--  2.0 unx      110 b- defN 23-May-10 21:57 autoprof-0.7.2.dist-info/WHEEL
--rw-rw-r--  2.0 unx       57 b- defN 23-May-10 21:57 autoprof-0.7.2.dist-info/entry_points.txt
--rw-rw-r--  2.0 unx        9 b- defN 23-May-10 21:57 autoprof-0.7.2.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     7093 b- defN 23-May-10 21:57 autoprof-0.7.2.dist-info/RECORD
-81 files, 554806 bytes uncompressed, 139124 bytes compressed:  74.9%
+-rw-rw-r--  2.0 unx    35149 b- defN 23-May-21 17:44 autoprof-0.7.3.dist-info/LICENSE
+-rw-rw-r--  2.0 unx     3812 b- defN 23-May-21 17:44 autoprof-0.7.3.dist-info/METADATA
+-rw-rw-r--  2.0 unx      110 b- defN 23-May-21 17:44 autoprof-0.7.3.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       57 b- defN 23-May-21 17:44 autoprof-0.7.3.dist-info/entry_points.txt
+-rw-rw-r--  2.0 unx        9 b- defN 23-May-21 17:44 autoprof-0.7.3.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     7177 b- defN 23-May-21 17:44 autoprof-0.7.3.dist-info/RECORD
+82 files, 561960 bytes uncompressed, 141061 bytes compressed:  74.9%
```

## zipnote {}

```diff
@@ -45,14 +45,17 @@
 
 Filename: autoprof/image/jacobian_image.py
 Comment: 
 
 Filename: autoprof/image/model_image.py
 Comment: 
 
+Filename: autoprof/image/psf_image.py
+Comment: 
+
 Filename: autoprof/image/target_image.py
 Comment: 
 
 Filename: autoprof/image/window_object.py
 Comment: 
 
 Filename: autoprof/models/__init__.py
@@ -219,26 +222,26 @@
 
 Filename: autoprof/utils/isophote/extract.py
 Comment: 
 
 Filename: autoprof/utils/isophote/integrate.py
 Comment: 
 
-Filename: autoprof-0.7.2.dist-info/LICENSE
+Filename: autoprof-0.7.3.dist-info/LICENSE
 Comment: 
 
-Filename: autoprof-0.7.2.dist-info/METADATA
+Filename: autoprof-0.7.3.dist-info/METADATA
 Comment: 
 
-Filename: autoprof-0.7.2.dist-info/WHEEL
+Filename: autoprof-0.7.3.dist-info/WHEEL
 Comment: 
 
-Filename: autoprof-0.7.2.dist-info/entry_points.txt
+Filename: autoprof-0.7.3.dist-info/entry_points.txt
 Comment: 
 
-Filename: autoprof-0.7.2.dist-info/top_level.txt
+Filename: autoprof-0.7.3.dist-info/top_level.txt
 Comment: 
 
-Filename: autoprof-0.7.2.dist-info/RECORD
+Filename: autoprof-0.7.3.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## autoprof/__init__.py

```diff
@@ -1,15 +1,15 @@
 import sys
 import argparse
 import requests
 from .parse_config import galfit_config, basic_config
 from . import models, image, plots, utils, fit, AP_config
 
 # meta data
-__version__ = "0.7.2"
+__version__ = "0.7.3"
 __author__ = "Connor Stone"
 __email__ = "connorstone628@gmail.com"
 
 
 def run_from_terminal() -> None:
     """
     Execute AutoProf from the command line with various options.
```

## autoprof/image/__init__.py

```diff
@@ -1,11 +1,12 @@
 from .image_object import *
 from .image_header import *
 from .target_image import *
 from .jacobian_image import *
+from .psf_image import *
 from .model_image import *
 from .window_object import *
 
 """
 Import all the classes from the module.
 
 1st import: Imports classes for representing images with pixel values, pixel scale, and window coordinates on the sky.
```

## autoprof/image/target_image.py

```diff
@@ -3,14 +3,15 @@
 import torch
 import numpy as np
 from torch.nn.functional import avg_pool2d
 
 from .image_object import Image, Image_List
 from .jacobian_image import Jacobian_Image, Jacobian_Image_List
 from .model_image import Model_Image, Model_Image_List
+from .psf_image import PSF_Image
 from astropy.io import fits
 from .. import AP_config
 
 __all__ = ["Target_Image", "Target_Image_List"]
 
 
 class Target_Image(Image):
@@ -20,27 +21,33 @@
 
     """
 
     image_count = 0
 
     def __init__(self, *args, **kwargs):
         super().__init__(*args, **kwargs)
+        # set the band
+        self.band = kwargs.get("band", None)
+        
         if not self.has_variance:
             self.set_variance(kwargs.get("variance", None))
         if not self.has_mask:
             self.set_mask(kwargs.get("mask", None))
         if not self.has_psf:
-            self.set_psf(kwargs.get("psf", None))
-        self.psf_upscale = torch.as_tensor(
-            kwargs.get("psf_upscale", 1), dtype=torch.int32, device=AP_config.ap_device
-        )
+            self.set_psf(kwargs.get("psf", None), kwargs.get("psf_upscale", 1))
 
-        # set the band
-        self.band = kwargs.get("band", str(Target_Image.image_count))
-        Target_Image.image_count += 1
+    @property
+    def band(self):
+        if self._band is None:
+            self._band = str(Target_Image.image_count)
+            Target_Image.image_count += 1
+        return self._band
+    @band.setter
+    def band(self, val):
+        self._band = val
 
     @property
     def variance(self):
         if self.has_variance:
             return self._variance
         return torch.ones_like(self.data)
 
@@ -79,36 +86,14 @@
         raise AttributeError("This image does not have a PSF")
 
     @psf.setter
     def psf(self, psf):
         self.set_psf(psf)
 
     @property
-    def psf_border_int(self):
-        return torch.ceil(
-            (
-                1
-                + torch.flip(
-                    torch.tensor(
-                        self.psf.shape,
-                        dtype=AP_config.ap_dtype,
-                        device=AP_config.ap_device,
-                    ),
-                    (0,),
-                )
-                / self.psf_upscale
-            )
-            / 2
-        ).int()
-
-    @property
-    def psf_border(self):
-        return self.pixelscale * self.psf_border_int
-
-    @property
     def has_psf(self):
         try:
             return self._psf is not None
         except AttributeError:
             return False
 
     def set_variance(self, variance):
@@ -122,25 +107,27 @@
             variance.to(dtype=AP_config.ap_dtype, device=AP_config.ap_device)
             if isinstance(variance, torch.Tensor)
             else torch.as_tensor(
                 variance, dtype=AP_config.ap_dtype, device=AP_config.ap_device
             )
         )
 
-    def set_psf(self, psf):
+    def set_psf(self, psf, psf_upscale = 1):
         if psf is None:
             self._psf = None
             return
-        assert torch.all((torch.tensor(psf.shape) % 2) == 1), "psf must have odd shape"
-        self._psf = (
-            psf.to(dtype=AP_config.ap_dtype, device=AP_config.ap_device)
-            if isinstance(psf, torch.Tensor)
-            else torch.as_tensor(
-                psf, dtype=AP_config.ap_dtype, device=AP_config.ap_device
-            )
+        if isinstance(psf, PSF_Image):
+            self._psf = psf
+            return
+        
+        self._psf = PSF_Image(
+            psf,
+            psf_upscale = psf_upscale,
+            pixelscale = self.pixelscale / psf_upscale,
+            band = self.band,
         )
 
     def set_mask(self, mask):
         if mask is None:
             self._mask = None
             return
         assert mask.shape == self.data.shape, "mask must have same shape as data"
@@ -176,37 +163,35 @@
         can be used when one wishes to make temporary modifications to
         an image and then will want the original again.
 
         """
         return super().copy(
             mask=self._mask,
             psf=self._psf,
-            psf_upscale=self.psf_upscale,
             variance=self._variance,
             **kwargs,
         )
 
     def blank_copy(self, **kwargs):
         """Produces a blank copy of the image which has the same properties
         except that its data is not filled with zeros.
 
         """
         return super().blank_copy(
-            mask=self._mask, psf=self._psf, psf_upscale=self.psf_upscale, **kwargs
+            mask=self._mask, psf=self._psf, **kwargs
         )
 
     def get_window(self, window, **kwargs):
         """Get a sub-region of the image as defined by a window on the sky."""
         indices = window.get_indices(self)
         return super().get_window(
             window=window,
             variance=self._variance[indices] if self.has_variance else None,
             mask=self._mask[indices] if self.has_mask else None,
             psf=self._psf,
-            psf_upscale=self.psf_upscale,
             **kwargs,
         )
 
     def jacobian_image(
         self,
         parameters: Optional[List[str]] = None,
         data: Optional[torch.Tensor] = None,
@@ -236,51 +221,39 @@
             target_identity=self.identity,
             **kwargs,
         )
 
     def reduce(self, scale, **kwargs):
         MS = self.data.shape[0] // scale
         NS = self.data.shape[1] // scale
-        if self.has_psf:
-            PMS = self.psf.shape[0] // scale
-            PNS = self.psf.shape[1] // scale
 
         return super().reduce(
             scale=scale,
             variance=self.variance[: MS * scale, : NS * scale]
             .reshape(MS, scale, NS, scale)
             .sum(axis=(1, 3))
             if self.has_variance
             else None,
             mask=self.mask[: MS * scale, : NS * scale]
             .reshape(MS, scale, NS, scale)
             .amax(axis=(1, 3))
             if self.has_mask
             else None,
-            psf=self.psf[: PMS * scale, : PNS * scale]
-            .reshape(PMS, scale, PNS, scale)
-            .sum(axis=(1, 3))
-            if self.has_psf
-            else None,
-            psf_upscale=self.psf_upscale,  # should psf_upscale change with reduce?
+            psf=self.psf.reduce(scale) if self.has_psf else None,
             **kwargs,
         )
 
     def expand(self, padding):
         raise NotImplementedError("expand not available for Target_Image yet")
 
     def _save_image_list(self):
         image_list = super()._save_image_list()
         if self._psf is not None:
             psf_header = fits.Header()
-            psf_header["IMAGE"] = "PSF"
-            psf_header["UPSCALE"] = int(self.psf_upscale.detach().cpu().item())
-            image_list.append(
-                fits.ImageHDU(self._psf.detach().cpu().numpy(), header=psf_header)
-            )
+            self.psf._save_image_list(image_list, psf_header)
         if self._variance is not None:
             var_header = fits.Header()
             var_header["IMAGE"] = "VARIANCE"
             image_list.append(
                 fits.ImageHDU(self._variance.detach().cpu().numpy(), header=var_header)
             )
         if self._mask is not None:
@@ -294,18 +267,15 @@
         return image_list
 
     def load(self, filename):
         hdul = super().load(filename)
 
         for hdu in hdul:
             if "IMAGE" in hdu.header and hdu.header["IMAGE"] == "PSF":
-                self.set_psf(np.array(hdu.data, dtype=np.float64))
-                self.psf_upscale = torch.tensor(
-                    hdu.header["UPSCALE"], dtype=torch.int32, device=AP_config.ap_device
-                )
+                self.set_psf(PSF_Image(np.array(hdu.data, dtype=np.float64), psf_upscale = hdu.header["UPSCALE"], pixelscale = self.pixelscale / hdu.header["UPSCALE"]))
             if "IMAGE" in hdu.header and hdu.header["IMAGE"] == "VARIANCE":
                 self.set_variance(np.array(hdu.data, dtype=np.float64))
             if "IMAGE" in hdu.header and hdu.header["IMAGE"] == "MASK":
                 self.set_mask(np.array(hdu.data, dtype=bool))
         return hdul
```

## autoprof/models/core_model.py

```diff
@@ -77,14 +77,15 @@
         self.constraints = kwargs.get("constraints", None)
         self.equality_constraints = []
         self.parameters = {}
         self.requires_grad = kwargs.get("requires_grad", False)
         self.target = target
         self.window = window
         self._locked = locked
+        self.mask = kwargs.get("mask", None)
 
     def add_equality_constraint(self, model, parameter):
         if isinstance(parameter, (tuple, list)):
             for P in parameter:
                 self.add_equality_constraint(model, P)
             return
         self.parameters[parameter] = model[parameter]
```

## autoprof/models/model_object.py

```diff
@@ -3,15 +3,15 @@
 import io
 
 from torch.autograd.functional import jacobian
 import numpy as np
 import torch
 
 from .core_model import AutoProf_Model
-from ..image import Model_Image, Window
+from ..image import Model_Image, Window, PSF_Image
 from .parameter_object import Parameter
 from ..utils.initialize import center_of_mass
 from ..utils.decorators import ignore_numpy_warnings
 from ..utils.operations import fft_convolve_torch, fft_convolve_multi_torch, selective_integrate
 from ..utils.interpolate import _shift_Lanczos_kernel_torch
 from ..utils.conversions.coordinates import coord_to_index, index_to_coord
 from ._shared_methods import select_target
@@ -81,14 +81,16 @@
     # Parameters which are treated specially by the model object and should not be updated directly when initializing
     special_kwargs = ["parameters", "filename", "model_type"]
     useable = False
 
     def __init__(self, name, *args, **kwargs):
         super().__init__(name, *args, **kwargs)
 
+        self.psf = None
+        
         # Set any user defined attributes for the model
         for kwarg in kwargs:  # fixme move to core model?
             # Skip parameters with special behaviour
             if kwarg in self.special_kwargs:
                 continue
             # Set the model parameter
             setattr(self, kwarg, kwargs[kwarg])
@@ -111,14 +113,33 @@
         except AttributeError:
             return {}
 
     @parameters.setter
     def parameters(self, val):
         self._parameters = val
 
+    @property
+    def psf(self):
+        if self._psf is None:
+            return self.target.psf
+        return self._psf
+
+    @psf.setter
+    def psf(self, val):
+        if val is None:
+            self._psf = None
+        elif isinstance(val, PSF_Image):
+            self._psf = val
+        else:
+            self._psf = PSF_Image(
+                val,
+                pixelscale = self.target.pixelscale,
+                band = self.target.band,
+            )
+
     def parameter_order(self, parameters_identity: Optional[tuple] = None):
         """Returns a tuple of names of the parameters in their set order."""
         param_order = tuple()
         for P in self.__class__._parameter_order:
             if self[P].locked:
                 continue
             if parameters_identity is not None and not any(
@@ -236,17 +257,17 @@
             working_window = window.copy() & image.window
 
         if "window" in self.psf_mode:
             raise NotImplementedError("PSF convolution in sub-window not available yet")
 
         if "full" in self.psf_mode:
             # Add border for psf convolution edge effects, will be cropped out later
-            working_window += self.target.psf_border
+            working_window += self.psf.psf_border
             # Determine the pixels scale at which to evalaute, this is smaller if the PSF is upscaled
-            working_pixelscale = image.pixelscale / self.target.psf_upscale
+            working_pixelscale = image.pixelscale / self.psf.psf_upscale
             # Sub pixel shift to align the model with the center of a pixel
             align = self.target.pixel_center_alignment()
             center_shift = (
                 self["center"].value
                 - (
                     torch.round(self["center"].value / working_pixelscale - align)
                     + align
@@ -287,27 +308,31 @@
                 -center_shift[0] / working_image.pixelscale,
                 -center_shift[1] / working_image.pixelscale,
                 3,
                 AP_config.ap_dtype,
                 AP_config.ap_device,
             )
             shift_psf = torch.nn.functional.conv2d(
-                self.target.psf.view(1, 1, *self.target.psf.shape),
+                self.psf.data.view(1, 1, *self.psf.data.shape),
                 LL.view(1, 1, *LL.shape),
                 padding="same",
             )[0][0]
             working_image.data = fft_convolve_torch(
                 working_image.data, shift_psf / torch.sum(shift_psf), img_prepadded=True
             )
             # Shift image back to align with original pixel grid
             working_image.window.shift_origin(-center_shift)
             # Add the sampled/integrated/convolved pixels to the requested image
-            image += working_image.reduce(self.target.psf_upscale).crop(
-                self.target.psf_border_int
+            working_image = working_image.reduce(self.psf.psf_upscale).crop(
+                self.psf.psf_border_int
             )
+            if self.mask is not None:
+                working_image.data = working_image.data * torch.logical_not(self.mask)
+            image += working_image
+            
         else:
             # Create an image to store pixel samples
             working_image = Model_Image(
                 pixelscale=image.pixelscale, window=working_window
             )
             # Evaluate the model on the image
             working_image.data += self.evaluate_model(image = working_image)
@@ -330,14 +355,16 @@
                     working_image,
                     self.integrate_window(working_image, "pixel"),
                     self.integrate_recursion_depth,
                 )
             else:
                 raise ValueError(f"{self.name} has unknown integration mode: {self.integrate_mode}")
             # Add the sampled/integrated pixels to the requested image
+            if self.mask is not None:
+                working_image.data = working_image.data * torch.logical_not(self.mask)
             image += working_image
 
         return image
 
     def window_integrate(
         self, working_image: "Image", window: Window, depth: int = 2
     ):
```

## autoprof/models/psf_model.py

```diff
@@ -34,19 +34,20 @@
     useable = True
 
     lanczos_kernel_size = 5
     clip_lanczos_kernel = True
 
     def __init__(self, *args, **kwargs):
         super().__init__(*args, **kwargs)
+        # fixme, model already has PSF interface, those can just be merged
         if "psf" in kwargs:
             self.psf_model = kwargs["psf"]
         else:
             self.psf_model = Model_Image(
-                data=torch.clone(self.target.psf), pixelscale=self.target.pixelscale
+                data=torch.clone(self.psf.data), pixelscale=self.psf.pixelscale,
             )
 
     @torch.no_grad()
     @ignore_numpy_warnings
     @select_target
     def initialize(self, target=None):
         super().initialize(target)
```

## autoprof/utils/conversions/optimization.py

```diff
@@ -1,73 +1,74 @@
 import numpy as np
 import torch
+from ... import AP_config
 
 
 def boundaries(val, limits):
     """val in limits expanded to range -inf to inf"""
-    tval = val if isinstance(val, torch.Tensor) else torch.tensor(val)
+    tval = val if isinstance(val, torch.Tensor) else torch.tensor(val,device=AP_config.ap_device, dtype = AP_config.ap_dtype)
     if limits[0] is None:
         return tval - 1.0 / (tval - limits[1])  # fixme check + or -?
     elif limits[1] is None:
         return tval - 1.0 / (tval - limits[0])
     return torch.tan((tval - limits[0]) * np.pi / (limits[1] - limits[0]) - np.pi / 2)
 
 
 def inv_boundaries(val, limits):
     """val in range -inf to inf compressed to within the limits"""
 
-    tval = torch.as_tensor(val)
+    tval = torch.as_tensor(val, device = AP_config.ap_device, dtype = AP_config.ap_dtype)
     if limits[0] is None:
         return (tval + limits[1] - torch.sqrt(torch.pow(tval - limits[1], 2) + 4)) * 0.5
     elif limits[1] is None:
         return (tval + limits[0] + torch.sqrt(torch.pow(tval - limits[0], 2) + 4)) * 0.5
     return (torch.arctan(tval) + np.pi / 2) * (limits[1] - limits[0]) / np.pi + limits[
         0
     ]
 
 
 def d_boundaries_dval(val, limits):
     """derivative of: val in limits expanded to range -inf to inf"""
-    tval = torch.as_tensor(val)
+    tval = torch.as_tensor(val, device = AP_config.ap_device, dtype = AP_config.ap_dtype)
     if limits[0] is None:
         return 1.0 + 1.0 / (tval - limits[1]) ** 2
     elif limits[1] is None:
         return 1.0 - 1.0 / (tval - limits[0]) ** 2
     return (np.pi / (limits[1] - limits[0])) / torch.cos(
         (tval - limits[0]) * np.pi / (limits[1] - limits[0]) - np.pi / 2
     ) ** 2
 
 
 def d_inv_boundaries_dval(val, limits):
     """derivative of: val in range -inf to inf compressed to within the limits"""
-    tval = torch.as_tensor(val)
+    tval = torch.as_tensor(val, device = AP_config.ap_device, dtype = AP_config.ap_dtype)
     if limits[0] is None:
         return 0.5 - 0.5 * (tval - limits[1]) / torch.sqrt(
             torch.pow(tval - limits[1], 2) + 4
         )
     elif limits[1] is None:
         return 0.5 + 0.5 * (tval - limits[0]) / torch.sqrt(
             torch.pow(tval - limits[0], 2) + 4
         )
     return (limits[1] - limits[0]) / (np.pi * (tval ** 2 + 1))
 
 
 def cyclic_boundaries(val, limits):
     """Applies cyclic boundary conditions to the input value."""
-    tval = val if isinstance(val, torch.Tensor) else torch.tensor(val)
+    tval = val if isinstance(val, torch.Tensor) else torch.tensor(val,device=AP_config.ap_device, dtype = AP_config.ap_dtype)
     return limits[0] + ((tval - limits[0]) % (limits[1] - limits[0]))
 
 
 def cyclic_difference_torch(val1, val2, period):
     """Applies the difference operation between two values with cyclic
     boundary conditions.
 
     """
-    tval1 = val1 if isinstance(val1, torch.Tensor) else torch.tensor(val1)
-    tval2 = val2 if isinstance(val2, torch.Tensor) else torch.tensor(val2)
+    tval1 = val1 if isinstance(val1, torch.Tensor) else torch.tensor(val1, device = AP_config.ap_device, dtype = AP_config.ap_dtype)
+    tval2 = val2 if isinstance(val2, torch.Tensor) else torch.tensor(val2, device = AP_config.ap_device, dtype = AP_config.ap_dtype)
     return torch.arcsin(torch.sin((tval1 - tval2) * np.pi / period)) * period / np.pi
 
 
 def cyclic_difference_np(val1, val2, period):
     """Applies the difference operation between two values with cyclic
     boundary conditions.
```

## Comparing `autoprof-0.7.2.dist-info/LICENSE` & `autoprof-0.7.3.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `autoprof-0.7.2.dist-info/METADATA` & `autoprof-0.7.3.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: autoprof
-Version: 0.7.2
+Version: 0.7.3
 Summary: A fast, flexible, differentiable, and automated astronomical image modelling tool for precise parallel multi-wavelength photometry
 Home-page: https://github.com/ConnorStoneAstro/AutoProf
 Author: Connor Stone
 Author-email: connorstone628@gmail.com
 License: GPL-3.0 license
 Platform: UNKNOWN
 Classifier: Development Status :: 1 - Planning
```

## Comparing `autoprof-0.7.2.dist-info/RECORD` & `autoprof-0.7.3.dist-info/RECORD`

 * *Files 8% similar despite different names*

```diff
@@ -1,43 +1,44 @@
 autoprof/AP_config.py,sha256=fIxYQr2lxsjA3ONiSLuKMAKmL2BPM7Xz99L3gGab8AQ,3171
-autoprof/__init__.py,sha256=Za1FqQvHBBI2D8ZL6Qf0C8C_lx3g0uEakHIguC1DvG4,5755
+autoprof/__init__.py,sha256=EvAu6BNZZ-ViFu_bh8IwHsvAE8tgubgY60hSZ5NL0Mk,5755
 autoprof/__main__.py,sha256=Ce_QoW2_-x3o3ZXbErfBFzJ_M20JzoaB3dUvwzAhXx4,281
 autoprof/fit/__init__.py,sha256=vPVo-YP7Ns-Y9hsAI_riY93kTtIi1FD5yw6Mdw3bQUY,1092
 autoprof/fit/base.py,sha256=XqH9gP9BgtFX05vO6aUg40XpDJ8jLTn1DmWhtF5HGvs,6682
 autoprof/fit/gp.py,sha256=PvMC6LeAIYWwDteVVo3AY7lb_TkQOY2-C5yWfK4CpUY,30
 autoprof/fit/gradient.py,sha256=N1RzlOkWjo0yoNxD483v6EVFtvNODiypLkCy7WoeEQw,6704
 autoprof/fit/hmc.py,sha256=4g0KS4U_mLbUT6VrNOcEG1bgXginFC2h0FQ-qZEiZok,6912
 autoprof/fit/iterative.py,sha256=5Jaa5ks3gsr0u1stvMNSZbCpJ71Q4E1RGhVV8SGWnJA,13206
 autoprof/fit/lm.py,sha256=kNPkGjTv9izC5oMAV56EMkBP7vHf8XyYqhUIJUK-x4k,31364
 autoprof/fit/mhmcmc.py,sha256=-3f_LfXFzB1KivEhHqdfUT38CpLw5JE_7_6aKWNjOJY,4317
 autoprof/fit/nuts.py,sha256=7DHgU_27_Eai7LF-Y_imDq4JUzbaiVSBzmYNszxHRPY,7109
-autoprof/image/__init__.py,sha256=ksiEV0RXh6C7szKH1TQQm6kAWG_S2fx4-4NqAmAyMLc,1125
+autoprof/image/__init__.py,sha256=UPRYMGXs_WUIEkyoDh0467vU495wES6JOLkL9kFKMP8,1150
 autoprof/image/image_header.py,sha256=EZc6YXArsirO5TIYOHzAcQXQseINYGmQBK6RbU637cI,11195
 autoprof/image/image_object.py,sha256=qqZ6hKfp3c0et4om-AmagH7Np4vZmjxaROJ_ysq81z8,21644
 autoprof/image/jacobian_image.py,sha256=1s3eAq3xB353i_srThMZVaJ7Wp-aXu0POLfvZ1JQSgg,5269
 autoprof/image/model_image.py,sha256=kcGG1_d-mYMUmDsYcJ9bTA7XNecS1rbt4dkRbcPNoLk,6615
-autoprof/image/target_image.py,sha256=y-_69PPjh2kKO5C9MoF4F3GeJdRtEekhblb_4U_Bd18,15842
+autoprof/image/psf_image.py,sha256=kDZerYwHv8oiXcMGqkkeyGRujkjJ_6h7ffQC1LdUZfQ,6868
+autoprof/image/target_image.py,sha256=vMLjom2MCH6DwozIc9m8sEW8RNJsKFzpVQDM2q6gza8,14679
 autoprof/image/window_object.py,sha256=DbOnZQmbYMQKB1T_Z-Fpc6PdEENFIGxy7QSGLY0s4jI,22836
 autoprof/models/__init__.py,sha256=V5ziTIawNay5GoqHIz-x1rnIOZqARe5VmMyFPCWLOR8,654
 autoprof/models/_model_methods.py,sha256=rZh4fuVedfFmzaLJsrdZ_a4WG96JTk9E76SX8Pe0Ues,4277
 autoprof/models/_shared_methods.py,sha256=xVoaFC7G93XAA1gW4FEwT7lvfeDl66E00NdvvEgpph0,20408
-autoprof/models/core_model.py,sha256=N_2k3PVoBRgrZbnkcfJAqZBXKSU2LHTBy-81foIFFvQ,21256
+autoprof/models/core_model.py,sha256=zP6RtZ39hHORvItYrlV-jnD0Lh56jjYHR52IF3OLJK8,21301
 autoprof/models/edgeon_model.py,sha256=sLMnjHHsBsVrDXzXSyoXe0BOw41lvE_NF5TOqExIuPU,5971
 autoprof/models/exponential_model.py,sha256=UTXjid2c4FzytoNsy92H5a1wNgMMbO7vax8Xxfy90s0,12945
 autoprof/models/flatsky_model.py,sha256=fRWxSHFhMDy_-UBixndvHszgO5NjHAYgkMH0EyKqxHg,2025
 autoprof/models/foureirellipse_model.py,sha256=-_-qhJ1Sm1FEkvsnrylmu2v5x41dmC4nQqi2a4VPWiU,8373
 autoprof/models/galaxy_model_object.py,sha256=oUUW1AYknC9HtvZb-Sx-Rib2DTl-ARyMYpIMPjs1c7c,4905
 autoprof/models/gaussian_model.py,sha256=7tO9Oi42PQz5qnwlC0DTC2bBTolcUuYZB4wW_m2fgAY,11956
 autoprof/models/group_model_object.py,sha256=9D4ESQ6Ip468Qo08LySQDFrSD6ngnmOoAJd5YQSRb8w,14833
-autoprof/models/model_object.py,sha256=7f-mko2GS-_HWlNILbMi2WHxAnIJAzYZ1DPH-O65MJw,25919
+autoprof/models/model_object.py,sha256=Zx4wH5SDf5yB4U5WEDmbbxNduNSpN0Fa8wRNLzwel5k,26717
 autoprof/models/moffat_model.py,sha256=95QW6XkGdTjnoTRUOD4rsb4DtCS6BSKd2SR9rFnzuTo,3487
 autoprof/models/nuker_model.py,sha256=y0kt5RvOyXeFEmyaf2MGerojt0g5SIA5FHpzTub0Ojk,17419
 autoprof/models/parameter_object.py,sha256=7IxvTaTbVl8B6nMsJOdwIYVNUMS6vQpAEz0Hpx9zO5E,17694
 autoprof/models/planesky_model.py,sha256=pvlx5mtww1ICJIDf4ME5k99xo3aayo6hBNPJs2-Xd7I,2292
-autoprof/models/psf_model.py,sha256=DNQ8ISrS0p6FBfKfCBGkXsShHfrX2pfkhkjfpfYPsJA,3519
+autoprof/models/psf_model.py,sha256=bmXqBxpwmf8EBn4CmM47DzJamob5AoDsnixywpe3ggA,3590
 autoprof/models/ray_model.py,sha256=9_VgnGFUaYPh33hQ0Ycoa_13Z-pBC17pKOfhPQY7CWg,4653
 autoprof/models/sersic_model.py,sha256=upYrrTHjkUXB6fTBrROtplImIZXEsDYwykntxZWAqjc,14762
 autoprof/models/sky_model_object.py,sha256=WD450x05pnwMDOzDo5yhQfqYXAHgE8QPkJLVyKJeFGQ,875
 autoprof/models/spline_model.py,sha256=BqAZ2G9nBdxQaNuFI_gJPAFPYcc25ZuNSm5HvfBaXyw,10300
 autoprof/models/star_model_object.py,sha256=kc57eQy02n02zCJKKqLDXoqoa0ZqgrzBONLpJUgRKZ4,1125
 autoprof/models/superellipse_model.py,sha256=6zfF5DJ2__qu_-2R6Attn4UKC8Z-ru8YL6Rpem40hqw,3073
 autoprof/models/warp_model.py,sha256=7zEmr2bwZ2J8cj4tfvtlPetnSX7jy4DHsF022V6ytM4,4412
@@ -58,24 +59,24 @@
 autoprof/utils/operations.py,sha256=LLO8LB02L3sJMsmlKiH3XS2m4dZBFxwq2aN8o8v0evs,6369
 autoprof/utils/optimization.py,sha256=VkAusKnyc4zyztbceazKADVy85g6VV7qqYIw6V7cQos,963
 autoprof/utils/parametric_profiles.py,sha256=JY6reeVkATmuPkhKY7cWPgrnpZaM--simb-8mS2xh1A,5990
 autoprof/utils/conversions/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 autoprof/utils/conversions/coordinates.py,sha256=zXdOxPurvoh3szKaEKx02jRCK_z1JfWeg17Z1Hl9a7g,2317
 autoprof/utils/conversions/dict_to_hdf5.py,sha256=XIy_JvX8Nrp-9N3sk5F3gIY2YLX5I88HxEYWbPGbfsU,1095
 autoprof/utils/conversions/functions.py,sha256=YEKL5WAZvBQkR_P0DK255SIYtJoRzQmnbcEoCbweHIs,1829
-autoprof/utils/conversions/optimization.py,sha256=FGlTum_ddqPDXYSN2mkFJUuRaPj385chL49nV3HABa8,2728
+autoprof/utils/conversions/optimization.py,sha256=SK-NgobNShnoPN4mTXyIHm4EDbEKvxQYjDGwSC9fuBM,3154
 autoprof/utils/conversions/units.py,sha256=KtYFzdH1_vG7JAPWiAkrAISfPmsN_0GNk9aJbFWLXEc,2536
 autoprof/utils/initialize/__init__.py,sha256=3loeT7k8s7wtWy_RZvGgTyxnlLKCe3AzpPUBI995Qz0,281
 autoprof/utils/initialize/center.py,sha256=PiL0-oXOzY-J3IUoK-bJy_w1Fv7LZZwdEcN7-kRJcZM,3103
 autoprof/utils/initialize/construct_psf.py,sha256=Ai_drJ50Bi2xQx4UcJpjOCkU3k24lejWolNmHPl0nnc,4495
 autoprof/utils/initialize/initialize.py,sha256=V1Epy8vudmquOxSB5S-moCcS7bvjdr5qze6IcqihsSs,3921
 autoprof/utils/initialize/segmentation_map.py,sha256=6fG5U4y5P6MDnX4_6ROBdRhUq6TxgbwVG1V3MaLf7-c,7036
 autoprof/utils/isophote/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 autoprof/utils/isophote/ellipse.py,sha256=p2SGzU067jBIBrKjhYKpnJQF7MSThMcnLajsaXeJ23k,1085
 autoprof/utils/isophote/extract.py,sha256=ousarHmkj7GrgAZ6mO3G-QY0tXjhd8bBh6lHzb--d6U,8531
 autoprof/utils/isophote/integrate.py,sha256=jNOCbSYC1dZO1pasEMcRUqZCpt43DEPVME4Hsa37DKQ,7012
-autoprof-0.7.2.dist-info/LICENSE,sha256=OXLcl0T2SZ8Pmy2_dmlvKuetivmyPd5m1q-Gyd-zaYY,35149
-autoprof-0.7.2.dist-info/METADATA,sha256=RBEvgJv_l7CAd0DssTkBbBw-BOrAYfEzLDsdPIh6Ze0,3812
-autoprof-0.7.2.dist-info/WHEEL,sha256=a-zpFRIJzOq5QfuhBzbhiA1eHTzNCJn8OdRvhdNX0Rk,110
-autoprof-0.7.2.dist-info/entry_points.txt,sha256=CJw03tyO_XyE5_-xxRzbAg74ITHASY47DhUiRVsn67s,57
-autoprof-0.7.2.dist-info/top_level.txt,sha256=8N1I5eyEKnh1QOUENsiy7fDvtU-sfyRCYsUJPzrvPvc,9
-autoprof-0.7.2.dist-info/RECORD,,
+autoprof-0.7.3.dist-info/LICENSE,sha256=OXLcl0T2SZ8Pmy2_dmlvKuetivmyPd5m1q-Gyd-zaYY,35149
+autoprof-0.7.3.dist-info/METADATA,sha256=3KRTMYL8WJtSPWKNAXyiFx873W48mArDa_nylBV5sfs,3812
+autoprof-0.7.3.dist-info/WHEEL,sha256=a-zpFRIJzOq5QfuhBzbhiA1eHTzNCJn8OdRvhdNX0Rk,110
+autoprof-0.7.3.dist-info/entry_points.txt,sha256=CJw03tyO_XyE5_-xxRzbAg74ITHASY47DhUiRVsn67s,57
+autoprof-0.7.3.dist-info/top_level.txt,sha256=8N1I5eyEKnh1QOUENsiy7fDvtU-sfyRCYsUJPzrvPvc,9
+autoprof-0.7.3.dist-info/RECORD,,
```

